#!/usr/bin/env python3

# core
import sys
import os
# command line program
import argparse
# directory operations
import shutil
import glob

# TODO: try removing the learn parameters when not relevant

def run(args):
    # init utils
    script_dir = os.path.dirname(os.path.realpath(__file__))
    code_dir = script_dir + "/.."
    # copy directory
    shutil.copytree(code_dir + "/app/default", args.name, ignore=shutil.ignore_patterns('__*'))
    # link post
    os.symlink(os.path.relpath(code_dir + "/modules/pyp0st/libpost.py", args.name + "/post_process/"), args.name + "/post_process/libpost.py")
    ## interface
    ### lib
    os.symlink(os.path.relpath(code_dir + "/app/interface/libset.py", args.name), args.name + "/libset.py")
    ### clean
    os.symlink(os.path.relpath(code_dir + "/app/interface/clean_build.py", args.name), args.name + "/clean_build")
    os.symlink(os.path.relpath(code_dir + "/app/interface/clean_time.py", args.name), args.name + "/clean_time")
    os.symlink(os.path.relpath(code_dir + "/app/interface//post_process/clean_post_process.py", args.name + "/post_process"), args.name + "/post_process/clean")
    ### post_process
    os.symlink(os.path.relpath(code_dir + "/app/interface/post_process/run_post_process.py", args.name + "/post_process"), args.name + "/post_process/run_post_process")
    os.symlink(os.path.relpath(code_dir + "/app/interface/post_process/cli_run_post_process.py", args.name + "/post_process"), args.name + "/post_process/.cli_run_post_process")
    os.symlink(os.path.relpath(code_dir + "/app/interface/post_process/gui_run_post_process.py", args.name + "/post_process"), args.name + "/post_process/.gui_run_post_process")
    ###################### main
    ### basic
    os.symlink(os.path.relpath(code_dir + "/app/interface/_run.py", args.name), args.name + "/run")
    os.symlink(os.path.relpath(code_dir + "/app/interface/_set_parameter.py", args.name), args.name + "/set_parameter")
    os.symlink(os.path.relpath(code_dir + "/app/interface/_post.py", args.name), args.name + "/post")
    os.symlink(os.path.relpath(code_dir + "/app/interface/_learn.py", args.name), args.name + "/learn")
    ### env
    #### flow
    os.symlink(os.path.relpath(code_dir + "/app/interface/flow/_choose.py", args.name + "/param/flow"), args.name + "/param/flow/choose")
    #### solutions
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/_copy_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/copy_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/_remove_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/remove_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/_batch_copy_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/batch_copy_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/_create_new_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/create_new_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/_rename_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/rename_equation")
    #### equation
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/equation/_choose.py", args.name + "/param/solutions/passive_particles"), args.name + "/param/solutions/passive_particles/choose")
    ###################### cli
    ### basic
    os.symlink(os.path.relpath(code_dir + "/app/interface/cli_run.py", args.name), args.name + "/.cli_run")
    os.symlink(os.path.relpath(code_dir + "/app/interface/cli_set_parameter.py", args.name), args.name + "/.cli_set_parameter")
    os.symlink(os.path.relpath(code_dir + "/app/interface/cli_post.py", args.name), args.name + "/.cli_post")
    os.symlink(os.path.relpath(code_dir + "/app/interface/cli_learn.py", args.name), args.name + "/.cli_learn")
    ### env
    #### flow
    os.symlink(os.path.relpath(code_dir + "/app/interface/flow/cli_choose.py", args.name + "/param/flow"), args.name + "/param/flow/.cli_choose")
    #### solutions
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/cli_copy_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.cli_copy_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/cli_remove_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.cli_remove_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/cli_batch_copy_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.cli_batch_copy_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/cli_create_new_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.cli_create_new_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/cli_rename_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.cli_rename_equation")
    #### equation
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/equation/cli_choose.py", args.name + "/param/solutions/passive_particles"), args.name + "/param/solutions/passive_particles/.cli_choose")
    ###################### gui
    ### basic
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_run.py", args.name), args.name + "/.gui_run")
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_set_parameter.py", args.name), args.name + "/.gui_set_parameter")
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_post.py", args.name), args.name + "/.gui_post")
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_learn.py", args.name), args.name + "/.gui_learn")
    ### env
    #### flow
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_choose.py", args.name + "/param/flow"), args.name + "/param/flow/.gui_choose")
    #### solutions
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/gui_copy_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.gui_copy_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/gui_remove_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.gui_remove_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/gui_create_new_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.gui_create_new_equation")
    os.symlink(os.path.relpath(code_dir + "/app/interface/solutions/gui_rename_equation.py", args.name + "/param/solutions"), args.name + "/param/solutions/.gui_rename_equation")
    #### equation
    os.symlink(os.path.relpath(code_dir + "/app/interface/gui_choose.py", args.name + "/param/solutions/passive_particles"), args.name + "/param/solutions/passive_particles/.gui_choose")
    ### set default case
    os.chdir(args.name)
    os.system(code_dir + "/app/cases/" + args.case + ".py")
    os.chdir('..')

def main():
    # set choices
    script_dir = os.path.dirname(os.path.realpath(__file__))
    code_dir = script_dir + "/.."
    choices = [c.split("/")[-1][:-3] for c in glob.glob(code_dir + "/app/cases/*.py")]
    choices.sort()
    # parse
    parser = argparse.ArgumentParser(description='create a new simulation case based on a default one')
    parser.add_argument('name', help='specify the name of the new simulation case')
    parser.add_argument('-c', '--case', default='default', choices=choices, help='match the new case to an example case')
    args = parser.parse_args()
    # run
    run(args)

if __name__ == '__main__':
    main()
